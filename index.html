<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buckshot Roulette (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap');
        
        :root {
            --bg-color: #1a1a1a;
            --card-bg-color: #2c2c2c;
            --border-color: #555;
            --text-color: #f0f0f0;
            --red-color: #d30000;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }
        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .pixel-font {
            font-family: 'Press+Start+2P', cursive;
        }
        .card {
            background-color: var(--card-bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        .btn {
            background-color: #4a4a4a;
            border: 2px solid #777;
            transition: all 0.2s;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover {
            background-color: #6a6a6a;
            border-color: #999;
        }
        .btn:disabled {
            background-color: #333;
            border-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-danger {
            background-color: #8b0000;
            border-color: #c00;
        }
        .btn-danger:hover {
            background-color: #b00;
            border-color: #f00;
        }
        .hp-bar-inner {
            background: linear-gradient(90deg, var(--red-color), #ff4500);
            transition: width 0.5s ease-in-out;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
        }

        /* 画面揺れのアニメーション */
        @keyframes shake-hard {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-8px, 8px) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translate(8px, -8px) rotate(2deg); }
        }
        @keyframes shake-soft {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 0px); }
            75% { transform: translate(2px, 0px); }
        }
        .shake-hard {
            animation: shake-hard 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        .shake-soft {
            animation: shake-soft 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body>

    <div id="game-container" class="w-full h-full flex flex-col p-2 hidden">
        <!-- ヘッダー -->
        <header class="flex-shrink-0 flex justify-between items-center mb-2">
            <h1 class="text-lg md:text-2xl pixel-font text-red-500">BUCKSHOT ROULETTE</h1>
            <div class="flex gap-2">
                <button id="items-btn" class="btn text-xs">アイテム</button>
                <button id="mute-btn" class="btn text-xs">Mute BGM</button>
            </div>
        </header>

        <!-- メインコンテンツエリア -->
        <main class="flex-grow flex flex-col md:flex-row gap-2 relative" style="min-height: 0;">
            <!-- 左半分 (プレイヤー + 中央情報) -->
            <div class="flex-grow flex flex-col gap-2">
                <!-- 他のプレイヤー -->
                <div id="players-grid" class="flex-grow grid grid-cols-1 gap-2 content-start overflow-y-auto" style="min-height: 100px;">
                    <!-- Player cards will be inserted here -->
                </div>

                <!-- 中央情報 -->
                <div class="flex-shrink-0 card p-3 flex flex-col items-center justify-center text-center">
                     <h2 class="text-base font-bold">現在の弾倉</h2>
                     <p class="text-lg">実弾 <span id="live-rounds" class="text-red-500 font-bold text-xl">0</span> / 空砲 <span id="blank-rounds" class="text-blue-400 font-bold text-xl">0</span></p>
                </div>
            </div>

            <!-- 右上ログ (常に表示) -->
            <div class="absolute top-0 right-0 w-48 h-1/2 md:h-full md:relative md:w-64 flex-shrink-0">
                <div class="card p-2 flex flex-col w-full h-full">
                    <h2 class="text-base font-bold mb-1 border-b border-gray-500 flex-shrink-0">ゲームログ</h2>
                    <div id="game-log" class="flex-grow overflow-y-auto space-y-1 pr-1 text-xs"></div>
                </div>
            </div>
        </main>

        <!-- 自分の情報 (下部) -->
        <footer id="my-info-area" class="card p-3 mt-2 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex-1 pr-2">
                    <h3 id="my-name" class="text-lg md:text-xl font-bold truncate"></h3>
                    <div class="w-full bg-gray-600 rounded-full h-4 mt-1">
                        <div id="my-hp-bar" class="hp-bar-inner h-4 rounded-full"></div>
                    </div>
                </div>
                <div id="my-actions" class="flex items-center gap-2 pl-2">
                     <button id="shoot-self-btn" class="btn text-sm">自分を撃つ</button>
                </div>
            </div>
        </footer>
    </div>

    <!-- ロビー画面 -->
    <div id="lobby" class="w-full max-w-md card p-8 text-center">
        <h1 class="text-3xl pixel-font text-red-500 mb-6">BUCKSHOT ROULETTE</h1>
        <p class="mb-4">プレイヤーを追加 (2~4人)</p>
        <div id="player-inputs" class="space-y-2 mb-4">
            <input type="text" placeholder="プレイヤー1の名前" class="player-name-input w-full p-2 rounded bg-gray-700 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500">
            <input type="text" placeholder="プレイヤー2の名前" class="player-name-input w-full p-2 rounded bg-gray-700 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
        <div class="flex gap-2 justify-center mb-6">
            <button id="add-player-btn" class="btn">追加</button>
            <button id="remove-player-btn" class="btn">削除</button>
        </div>
        <button id="start-game-btn" class="w-full p-3 btn btn-danger">ゲーム開始</button>
        <p id="lobby-error" class="text-red-400 mt-4"></p>
    </div>

    <!-- モーダルウィンドウ -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="modal-backdrop fixed inset-0"></div>
        <div id="modal-card" class="card p-6 relative z-10 w-full max-w-md text-center max-h-full overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <div id="modal-content"></div>
            <div id="modal-actions" class="mt-6 flex justify-center space-x-2">
                <button id="modal-confirm-btn" class="p-3 btn btn-danger">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- グローバル変数 ---
        let gameState = {};

        // ★変更点: アイテム定義を効果説明のみに変更
        const ITEMS = {
            'saw': { name: 'ノコギリ', description: '使用したターンのみ、実包のダメージが2になる。' },
            'magnifying-glass': { name: '虫眼鏡', description: '次に装弾されている弾を確認できる。' },
            'cigarette': { name: 'タバコ', description: '自分のライフを1回復する。' },
            'handcuffs': { name: '手錠', description: '敵を1ターン拘束する。' },
            'beer': { name: 'ビール', description: 'ターン消費せずに弾を1つ消費する。' },
            'expired-medicine': { name: '期限切れ薬', description: '50%でライフを2回復、50%で1喪失する。' },
            'adrenaline': { name: 'アドレナリン', description: '相手のアイテムを1つ盗み、即時使用する。' },
            'inverter': { name: 'インバータ', description: '弾倉内の空包と実包を入れ替える。' },
            'disposable-phone': { name: '使い捨て携帯', description: 'ランダムな1発が実包か空砲か教えてくれる。' },
        };

        // --- サウンド管理 (変更なし) ---
        const audioManager = { /* ... 省略 ... */ };

        // --- UI要素 ---
        const lobbyUI = document.getElementById('lobby');
        const gameContainerUI = document.getElementById('game-container');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const removePlayerBtn = document.getElementById('remove-player-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerInputsUI = document.getElementById('player-inputs');
        const lobbyErrorUI = document.getElementById('lobby-error');
        const muteBtn = document.getElementById('mute-btn');
        const itemsBtn = document.getElementById('items-btn');
        
        const modalUI = document.getElementById('modal');
        const modalTitleUI = document.getElementById('modal-title');
        const modalContentUI = document.getElementById('modal-content');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalBackdrop = document.querySelector('.modal-backdrop');

        // --- 初期化 ---
        window.onload = () => {
            addPlayerBtn.addEventListener('click', addPlayerInput);
            removePlayerBtn.addEventListener('click', removePlayerInput);
            startGameBtn.addEventListener('click', startGame);
            muteBtn.addEventListener('click', () => audioManager.toggleBgm());
            itemsBtn.addEventListener('click', showAllItems);
            // audioManager.init(); // 音声ファイルがないのでコメントアウト
        };
        
        // ★新規: アイテム一覧表示機能
        function showAllItems() {
            let contentHtml = '<div class="space-y-3 text-left">';
            for (const key in ITEMS) {
                const item = ITEMS[key];
                contentHtml += `<div><h4 class="font-bold text-red-400">${item.name}</h4><p class="text-sm text-gray-300">${item.description}</p></div>`;
            }
            contentHtml += '</div>';
            showModal('アイテム一覧', contentHtml, () => modalUI.classList.add('hidden'));
        }

        // --- ロビー関連の関数 (変更なし) ---
        function addPlayerInput() { /* ... */ }
        function removePlayerInput() { /* ... */ }
        function updatePlayerButtons() { /* ... */ }

        // --- ゲーム開始 ---
        function startGame() {
            const playerInputs = document.querySelectorAll('.player-name-input');
            const playerNames = Array.from(playerInputs).map(input => input.value.trim()).filter(name => name);
            
            if (playerNames.length < 2) { lobbyErrorUI.textContent = '少なくとも2人のプレイヤー名を入力してください。'; return; }
            if (new Set(playerNames).size !== playerNames.length) { lobbyErrorUI.textContent = 'プレイヤー名は重複しないようにしてください。'; return; }

            // ★変更点: gameStateからアイテム関連を削除
            gameState = {
                players: playerNames.map((name, index) => ({ id: index, name: name, hp: 4, maxHp: 4, isAlive: true })),
                gameState: 'playing',
                currentTurnPlayerIndex: 0,
                shotgun: { liveRounds: 0, blankRounds: 0, chamber: [] },
                log: [`ゲーム開始！ 参加者: ${playerNames.join(', ')}`],
            };

            lobbyUI.classList.add('hidden');
            gameContainerUI.classList.remove('hidden');
            
            // audioManager.play('bgm');
            startRound();
        }

        // --- ゲーム進行の関数 ---
        function startRound() {
            addLogEntry('--- 新ラウンド開始 ---');

            const liveRounds = Math.ceil(Math.random() * 3) + 1;
            const blankRounds = Math.ceil(Math.random() * 3) + 1;
            
            let chamber = Array(liveRounds).fill('live').concat(Array(blankRounds).fill('blank'));
            chamber.sort(() => Math.random() - 0.5);

            gameState.shotgun = { liveRounds, blankRounds, chamber };
            
            addLogEntry(`弾倉に装填: 実弾 ${liveRounds}, 空砲 ${blankRounds}`);

            showTurnTransition();
        }

        function handleShoot(targetPlayerId) {
            if (gameState.shotgun.chamber.length === 0) return;

            const currentPlayer = gameState.players[gameState.currentTurnPlayerIndex];
            const targetPlayer = gameState.players.find(p => p.id === targetPlayerId);
            const shell = gameState.shotgun.chamber.shift();
            const isLive = shell === 'live';
            
            let logMessage = `${currentPlayer.name}が${targetPlayer.id === currentPlayer.id ? '自分' : targetPlayer.name}を撃った...`;

            if (isLive) {
                // audioManager.play('shoot_live');
                triggerScreenShake('hard');
                const damage = 1; // ノコギリがないのでダメージは1で固定
                logMessage += ` 実弾！ ${damage}ダメージ！`;
                targetPlayer.hp -= damage;
                if (targetPlayer.hp <= 0) {
                    targetPlayer.hp = 0;
                    targetPlayer.isAlive = false;
                    logMessage += ` ${targetPlayer.name}は倒れた。`;
                }
                endTurn();
            } else {
                // audioManager.play('shoot_blank');
                triggerScreenShake('soft');
                logMessage += ' 空砲だった。';
                if (targetPlayer.id === currentPlayer.id) {
                    logMessage += ' ターンは継続する。';
                    // ターンを継続するのでendTurn()は呼ばない
                } else {
                    endTurn();
                }
            }
            
            addLogEntry(logMessage);

            gameState.shotgun.liveRounds = gameState.shotgun.chamber.filter(s => s === 'live').length;
            gameState.shotgun.blankRounds = gameState.shotgun.chamber.length - gameState.shotgun.liveRounds;

            if (checkGameOver()) { renderGame(); return; }

            if (gameState.shotgun.chamber.length === 0) {
                addLogEntry('弾切れです。');
                renderGame(); // 弾切れ表示
                setTimeout(startRound, 2000);
            } else {
                renderGame();
            }
        }

        function endTurn() {
            let nextPlayerIndex = (gameState.currentTurnPlayerIndex + 1) % gameState.players.length;
            
            // 生きている次のプレイヤーを探す
            while (!gameState.players[nextPlayerIndex].isAlive) {
                nextPlayerIndex = (nextPlayerIndex + 1) % gameState.players.length;
            }
            gameState.currentTurnPlayerIndex = nextPlayerIndex;
            
            if (!checkGameOver()) {
                showTurnTransition();
            }
        }
        
        function checkGameOver() {
            const alivePlayers = gameState.players.filter(p => p.isAlive);
            if (alivePlayers.length <= 1) {
                gameState.gameState = 'finished';
                const winner = alivePlayers[0];
                addLogEntry(`--- ゲーム終了 ---`);
                const title = winner ? `${winner.name}の勝利！` : '引き分け！';
                const content = winner ? 'おめでとうございます！' : '勝者はいませんでした。';
                addLogEntry(title);
                showModal(title, content, () => { window.location.reload(); });
                return true;
            }
            return false;
        }

        function addLogEntry(message) {
            gameState.log.push(message);
            if (gameState.log.length > 50) gameState.log.shift();
            renderLog();
        }
        
        // --- 描画関数 ---
        function renderGame() {
            const currentPlayer = gameState.players[gameState.currentTurnPlayerIndex];
            const playersGrid = document.getElementById('players-grid');
            playersGrid.innerHTML = '';
            
            // 他のプレイヤーの表示
            gameState.players.forEach(player => {
                if (player.id === currentPlayer.id || !player.isAlive) return;

                const playerCard = document.createElement('div');
                playerCard.className = `card p-2 space-y-1`;
                const hpPercentage = (player.hp / player.maxHp) * 100;

                playerCard.innerHTML = `
                    <h3 class="text-base font-bold truncate">${player.name}</h3>
                    <div class="w-full bg-gray-600 rounded-full h-3">
                        <div class="hp-bar-inner h-3 rounded-full" style="width: ${hpPercentage}%"></div>
                    </div>
                `;

                const shootButton = document.createElement('button');
                shootButton.className = 'w-full mt-2 btn btn-danger text-sm p-1';
                shootButton.textContent = '撃つ';
                shootButton.onclick = () => handleShoot(player.id);
                playerCard.appendChild(shootButton);
                
                playersGrid.appendChild(playerCard);
            });

            // 自分の情報の表示
            document.getElementById('my-name').textContent = `${currentPlayer.name} (あなたのターン)`;
            document.getElementById('my-hp-bar').style.width = `${(currentPlayer.hp / currentPlayer.maxHp) * 100}%`;
            document.getElementById('shoot-self-btn').onclick = () => handleShoot(currentPlayer.id);

            // 全体情報
            document.getElementById('live-rounds').textContent = gameState.shotgun.liveRounds;
            document.getElementById('blank-rounds').textContent = gameState.shotgun.blankRounds;

            renderLog();
        }
        
        // ★新規: ログ専用の描画関数
        function renderLog(){
            const gameLog = document.getElementById('game-log');
            if (gameLog) {
                gameLog.innerHTML = gameState.log.map(entry => `<div class="p-1">${entry}</div>`).join('');
                gameLog.scrollTop = gameLog.scrollHeight;
            }
        }

        function triggerScreenShake(intensity) { /* ... */ }
        function showTurnTransition() { /* ... */ }
        function showModal(title, content, onConfirm) { /* ... */ }

        // --- 関数の実装 (省略されている部分) ---
        // (省略された関数は以前のコードと同じです)
        audioManager.init = function() {}; // No sounds for now
        audioManager.play = function(name) {};
        audioManager.toggleBgm = function() {};
        addPlayerInput = function() {
            const inputs = playerInputsUI.getElementsByTagName('input');
            if (inputs.length < 4) {
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.placeholder = `プレイヤー${inputs.length + 1}の名前`;
                newInput.className = 'player-name-input w-full p-2 rounded bg-gray-700 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500';
                playerInputsUI.appendChild(newInput);
            }
            updatePlayerButtons();
        };
        removePlayerInput = function() {
            const inputs = playerInputsUI.getElementsByTagName('input');
            if (inputs.length > 2) {
                playerInputsUI.removeChild(inputs[inputs.length - 1]);
            }
            updatePlayerButtons();
        };
        updatePlayerButtons = function() {
            const inputs = playerInputsUI.getElementsByTagName('input');
            addPlayerBtn.disabled = inputs.length >= 4;
            removePlayerBtn.disabled = inputs.length <= 2;
        };
        triggerScreenShake = function(intensity) {
            const className = intensity === 'hard' ? 'shake-hard' : 'shake-soft';
            document.body.classList.remove('shake-hard', 'shake-soft');
            void document.body.offsetWidth;
            document.body.classList.add(className);
            setTimeout(() => {
                document.body.classList.remove(className);
            }, intensity === 'hard' ? 400 : 300);
        };
        showTurnTransition = function() {
            const currentPlayer = gameState.players[gameState.currentTurnPlayerIndex];
            showModal(`${currentPlayer.name} のターン`, `スマートフォンを ${currentPlayer.name} さんに渡してください。`,
                () => {
                    modalUI.classList.add('hidden');
                    renderGame();
                }
            );
        };
        showModal = function(title, content, onConfirm) {
            modalTitleUI.textContent = title;
            modalContentUI.innerHTML = typeof content === 'string' ? `<p>${content}</p>` : content;
            modalConfirmBtn.onclick = onConfirm;
            modalUI.classList.remove('hidden');
            modalUI.classList.add('flex');
            modalBackdrop.onclick = () => modalUI.classList.add('hidden'); // 背景クリックで閉じる
        };
    </script>
</body>
</html>

